<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI SIEM Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            card: '#1e293b',
            surface: '#0f172a',
          }
        }
      }
    }
  </script>
  <style>
    body { background: #0f172a; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    .severity-critical { color: #ef4444; }
    .severity-high { color: #f97316; }
    .severity-medium { color: #eab308; }
    .severity-low { color: #22c55e; }
    .badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .badge-critical { background: #7f1d1d; color: #fca5a5; }
    .badge-high { background: #7c2d12; color: #fdba74; }
    .badge-medium { background: #713f12; color: #fde047; }
    .badge-low { background: #14532d; color: #86efac; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    .alert-enter { animation: fadeIn 0.3s ease-out; }
  </style>
</head>
<body class="text-gray-200 min-h-screen">
  <!-- Header -->
  <header class="bg-card border-b border-gray-700 px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
      </svg>
      <h1 class="text-xl font-bold text-white">AI SIEM Dashboard</h1>
      <span class="text-sm text-gray-400 ml-2">Real-time Security Monitoring</span>
    </div>
    <div class="flex items-center gap-4">
      <span id="lastUpdate" class="text-xs text-gray-500"></span>
      <div class="flex items-center gap-2">
        <span id="wsIndicator" class="w-2.5 h-2.5 rounded-full bg-red-500"></span>
        <span id="wsStatus" class="text-xs text-gray-400">Disconnected</span>
      </div>
    </div>
  </header>

  <main class="max-w-[1600px] mx-auto p-6 space-y-6">
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-card rounded-lg p-5 border border-gray-700">
        <p class="text-sm text-gray-400">Total Events (24h)</p>
        <p id="totalEvents" class="text-3xl font-bold text-white mt-1">-</p>
      </div>
      <div class="bg-card rounded-lg p-5 border border-red-900/50">
        <p class="text-sm text-gray-400">Critical</p>
        <p id="criticalCount" class="text-3xl font-bold text-red-400 mt-1">-</p>
      </div>
      <div class="bg-card rounded-lg p-5 border border-orange-900/50">
        <p class="text-sm text-gray-400">High</p>
        <p id="highCount" class="text-3xl font-bold text-orange-400 mt-1">-</p>
      </div>
      <div class="bg-card rounded-lg p-5 border border-yellow-900/50">
        <p class="text-sm text-gray-400">Medium</p>
        <p id="mediumCount" class="text-3xl font-bold text-yellow-400 mt-1">-</p>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-card rounded-lg p-5 border border-gray-700">
        <h2 class="text-sm font-semibold text-gray-300 mb-4">Events by Severity</h2>
        <div class="flex justify-center" style="height: 280px;">
          <canvas id="severityChart"></canvas>
        </div>
      </div>
      <div class="bg-card rounded-lg p-5 border border-gray-700">
        <h2 class="text-sm font-semibold text-gray-300 mb-4">Events by Type</h2>
        <div style="height: 280px;">
          <canvas id="typeChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Events Table + Live Feed -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
      <!-- Events Table -->
      <div class="xl:col-span-2 bg-card rounded-lg border border-gray-700 overflow-hidden">
        <div class="px-5 py-3 border-b border-gray-700 flex items-center justify-between">
          <h2 class="text-sm font-semibold text-gray-300">Recent Security Events</h2>
          <span id="eventCount" class="text-xs text-gray-500"></span>
        </div>
        <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-800/50 sticky top-0">
              <tr class="text-left text-gray-400">
                <th class="px-4 py-2">ID</th>
                <th class="px-4 py-2">Type</th>
                <th class="px-4 py-2">Severity</th>
                <th class="px-4 py-2">Source IP</th>
                <th class="px-4 py-2">Detected By</th>
                <th class="px-4 py-2">Confidence</th>
                <th class="px-4 py-2">Status</th>
                <th class="px-4 py-2">Time</th>
              </tr>
            </thead>
            <tbody id="eventsBody" class="divide-y divide-gray-700/50">
              <tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Loading events...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Live Alert Feed -->
      <div class="bg-card rounded-lg border border-gray-700 overflow-hidden">
        <div class="px-5 py-3 border-b border-gray-700 flex items-center justify-between">
          <h2 class="text-sm font-semibold text-gray-300">Live Alert Feed</h2>
          <span class="relative flex h-2.5 w-2.5">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-blue-500"></span>
          </span>
        </div>
        <div id="alertFeed" class="p-3 space-y-2 max-h-[500px] overflow-y-auto">
          <p class="text-xs text-gray-500 text-center py-4">Waiting for alerts...</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ===== State =====
    let severityChart = null;
    let typeChart = null;
    let stompClient = null;
    let alertCount = 0;
    const MAX_ALERTS = 50;

    // ===== Charts =====
    const SEVERITY_COLORS = {
      CRITICAL: '#ef4444',
      HIGH: '#f97316',
      MEDIUM: '#eab308',
      LOW: '#22c55e'
    };

    const TYPE_COLORS = [
      '#3b82f6', '#8b5cf6', '#ec4899', '#06b6d4', '#10b981', '#f59e0b'
    ];

    function initCharts() {
      const defaultFont = { family: 'system-ui', size: 12 };
      Chart.defaults.color = '#94a3b8';
      Chart.defaults.font = defaultFont;

      severityChart = new Chart(document.getElementById('severityChart'), {
        type: 'doughnut',
        data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderWidth: 0 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: { position: 'right', labels: { padding: 16, usePointStyle: true, pointStyle: 'circle' } }
          }
        }
      });

      typeChart = new Chart(document.getElementById('typeChart'), {
        type: 'bar',
        data: { labels: [], datasets: [{ data: [], backgroundColor: TYPE_COLORS, borderWidth: 0, borderRadius: 4 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          scales: {
            x: { grid: { color: '#1e293b' }, ticks: { precision: 0 } },
            y: { grid: { display: false } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    // ===== API Calls =====
    async function fetchSummary() {
      try {
        const res = await fetch('/api/dashboard/summary?hours=24');
        if (!res.ok) throw new Error(res.status);
        const data = await res.json();

        document.getElementById('totalEvents').textContent = data.total_events ?? 0;
        document.getElementById('criticalCount').textContent = data.events_by_severity?.CRITICAL ?? 0;
        document.getElementById('highCount').textContent = data.events_by_severity?.HIGH ?? 0;
        document.getElementById('mediumCount').textContent = data.events_by_severity?.MEDIUM ?? 0;

        // Update severity chart
        const sevLabels = Object.keys(data.events_by_severity || {});
        const sevValues = Object.values(data.events_by_severity || {});
        const sevColors = sevLabels.map(l => SEVERITY_COLORS[l] || '#64748b');
        severityChart.data.labels = sevLabels;
        severityChart.data.datasets[0].data = sevValues;
        severityChart.data.datasets[0].backgroundColor = sevColors;
        severityChart.update();

        // Update type chart
        const typeLabels = Object.keys(data.events_by_type || {});
        const typeValues = Object.values(data.events_by_type || {});
        typeChart.data.labels = typeLabels.map(l => l.replace(/_/g, ' '));
        typeChart.data.datasets[0].data = typeValues;
        typeChart.update();

        document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
      } catch (e) {
        console.error('Failed to fetch summary:', e);
      }
    }

    async function fetchEvents() {
      try {
        const res = await fetch('/api/dashboard/events');
        if (!res.ok) throw new Error(res.status);
        const events = await res.json();

        const tbody = document.getElementById('eventsBody');
        document.getElementById('eventCount').textContent = events.length + ' events';

        if (events.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No events detected yet</td></tr>';
          return;
        }

        tbody.innerHTML = events.map(e => `
          <tr class="hover:bg-gray-800/30 transition-colors">
            <td class="px-4 py-2 text-gray-400">${e.id}</td>
            <td class="px-4 py-2 font-mono text-xs">${e.eventType ?? '-'}</td>
            <td class="px-4 py-2"><span class="badge badge-${(e.severity ?? '').toLowerCase()}">${e.severity ?? '-'}</span></td>
            <td class="px-4 py-2 font-mono text-xs">${e.sourceIp ?? '-'}</td>
            <td class="px-4 py-2 text-xs">${e.detectedBy ?? '-'}</td>
            <td class="px-4 py-2 text-xs">${e.confidence != null ? (e.confidence * 100).toFixed(0) + '%' : '-'}</td>
            <td class="px-4 py-2 text-xs">${e.status ?? '-'}</td>
            <td class="px-4 py-2 text-xs text-gray-400">${formatTime(e.createdAt)}</td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Failed to fetch events:', e);
      }
    }

    function formatTime(ts) {
      if (!ts) return '-';
      const d = new Date(ts);
      if (isNaN(d.getTime())) return ts;
      return d.toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    // ===== WebSocket =====
    function connectWebSocket() {
      const socket = new SockJS('/ws');
      stompClient = Stomp.over(socket);
      stompClient.debug = null; // suppress debug logs

      stompClient.connect({}, function () {
        document.getElementById('wsIndicator').className = 'w-2.5 h-2.5 rounded-full bg-green-500';
        document.getElementById('wsStatus').textContent = 'Connected';

        stompClient.subscribe('/topic/alerts', function (message) {
          try {
            const alert = JSON.parse(message.body);
            addAlertToFeed(alert);
            // Refresh data on new alert
            fetchSummary();
            fetchEvents();
          } catch (e) {
            console.error('Failed to parse alert:', e);
          }
        });
      }, function () {
        document.getElementById('wsIndicator').className = 'w-2.5 h-2.5 rounded-full bg-red-500';
        document.getElementById('wsStatus').textContent = 'Disconnected';
        // Reconnect after 5s
        setTimeout(connectWebSocket, 5000);
      });
    }

    function addAlertToFeed(alert) {
      const feed = document.getElementById('alertFeed');
      alertCount++;

      // Remove placeholder
      if (alertCount === 1) feed.innerHTML = '';

      const severity = alert.severity || 'MEDIUM';
      const div = document.createElement('div');
      div.className = 'alert-enter bg-gray-800/50 rounded-lg p-3 border border-gray-700/50';
      div.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="badge badge-${severity.toLowerCase()}">${severity}</span>
          <span class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</span>
        </div>
        <p class="text-xs text-gray-300">${alert.message || alert.eventType || 'New alert received'}</p>
        ${alert.sourceIp ? `<p class="text-xs text-gray-500 mt-1">Source: ${alert.sourceIp}</p>` : ''}
      `;

      feed.insertBefore(div, feed.firstChild);

      // Cap at MAX_ALERTS
      while (feed.children.length > MAX_ALERTS) {
        feed.removeChild(feed.lastChild);
      }
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', function () {
      initCharts();
      fetchSummary();
      fetchEvents();
      connectWebSocket();

      // Auto-refresh every 30s
      setInterval(function () {
        fetchSummary();
        fetchEvents();
      }, 30000);
    });
  </script>
</body>
</html>
